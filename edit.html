<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Éditer l'objet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-4">
<h2 class="mb-3">Modifier l'objet</h2>
<form id="editForm" class="mb-4">
  <div class="mb-3">
    <label class="form-label">Catégorie</label>
    <select id="category" class="form-select" required>
      <option value="pret">Prêt</option>
      <option value="dons">Dons</option>
    </select>
  </div>
  <div class="mb-3">
    <label class="form-label">Titre</label>
    <input type="text" class="form-control" id="title" required>
  </div>
  <div class="mb-3">
    <label class="form-label">Description</label>
    <textarea class="form-control" id="description" rows="3"></textarea>
  </div>
  <div class="mb-3">
    <label class="form-label">Remplacer la photo</label>
    <input type="file" class="form-control" id="photo" accept="image/*">
  </div>
  <button class="btn btn-primary">Enregistrer</button>
  <button id="deleteBtn" type="button" class="btn btn-danger">Supprimer</button>
  <a href="index.html" class="btn btn-link">Annuler</a>
  <p class="small text-danger mt-2 d-none" id="error"></p>
</form>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
import { SUPABASE_URL, SUPABASE_ANON_KEY } from './config.js';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

function getParam(name) {
  return new URLSearchParams(window.location.search).get(name);
}
const id = getParam('id');
if (!id) window.location.href='index.html';

async function requireAuth() {
  const { data: { session }} = await supabase.auth.getSession();
  if (!session) window.location.href = 'login.html';
  return session;
}
const session = await requireAuth();
const userId = session.user.id;

let item = null;
const errorEl = document.getElementById('error');

async function loadItem() {
  const { data, error } = await supabase.from('items').select('*').eq('id', id).single();
  if (error || !data) {
    window.location.href='index.html';
    return;
  }
  item = data;
  if (item.owner_id !== userId) {
    window.location.href='index.html';
    return;
  }
  document.getElementById('category').value = item.category;
  document.getElementById('title').value = item.title;
  document.getElementById('description').value = item.description || '';
}
await loadItem();

document.getElementById('editForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const cat = document.getElementById('category').value;
  const title = document.getElementById('title').value;
  const desc = document.getElementById('description').value;
  const fileInput = document.getElementById('photo');
  let imageUrl = item.image_url;

  if (fileInput.files[0]) {
    const file = fileInput.files[0];
    const filePath = `${Date.now()}_${file.name}`;
    const { error: uploadError } = await supabase.storage.from(cat).upload(filePath, file, { upsert:false });
    if (uploadError) {
      showError(uploadError.message);
      return;
    }
    imageUrl = supabase.storage.from(cat).getPublicUrl(filePath).data.publicUrl;
  }

  const { error } = await supabase.from('items').update({
    category: cat,
    title,
    description: desc,
    image_url: imageUrl
  }).eq('id', id);
  if (error) {
    showError(error.message);
  } else {
    window.location.href='index.html';
  }
});

document.getElementById('deleteBtn').addEventListener('click', async ()=>{
  if (!confirm('Supprimer cet objet ?')) return;
  const { error } = await supabase.from('items').delete().eq('id', id);
  if (error) {
    showError(error.message);
  } else {
    window.location.href='index.html';
  }
});

function showError(msg) {
  errorEl.textContent = msg;
  errorEl.classList.remove('d-none');
}
</script>
</body>
</html>
