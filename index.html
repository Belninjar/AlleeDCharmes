<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Objets — Copro Prêt & Dons</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Copro Objets</a>
    <div class="d-flex">
      <button id="addBtn" class="btn btn-success me-2">Nouvel objet</button>
      <button id="logoutBtn" class="btn btn-outline-secondary">Déconnexion</button>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div class="btn-group mb-4" role="group">
    <button class="btn btn-outline-primary active" data-filter="all">Tous</button>
    <button class="btn btn-outline-primary" data-filter="pret">Prêt</button>
    <button class="btn btn-outline-primary" data-filter="dons">Dons</button>
  </div>
  <div id="items" class="row g-4"></div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
import { SUPABASE_URL, SUPABASE_ANON_KEY } from './config.js';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

async function requireAuth() {
  const { data: { session }} = await supabase.auth.getSession();
  if (!session) window.location.href = 'login.html';
  return session;
}
await requireAuth();

document.getElementById('logoutBtn').addEventListener('click', async ()=>{
  await supabase.auth.signOut();
  window.location.href='login.html';
});
document.getElementById('addBtn').addEventListener('click', ()=>{
  window.location.href='new.html';
});

const filterBtns = document.querySelectorAll('[data-filter]');
filterBtns.forEach(btn=>btn.addEventListener('click', ()=>{
  filterBtns.forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  loadItems(btn.dataset.filter);
}));

async function loadItems(filter='all') {
  let query = supabase.from('items').select('*').order('inserted_at', { ascending:false });
  if (filter !== 'all') query = query.eq('category', filter);
  const { data, error } = await query;
  const container = document.getElementById('items');
  container.innerHTML='';
  if (error) {
    container.innerHTML = `<p class="text-danger">${error.message}</p>`;
    return;
  }
  const { data: { user } } = await supabase.auth.getUser();
  data.forEach(item=>{
    const col = document.createElement('div');
    col.className='col-12 col-sm-6 col-lg-4';
    col.innerHTML = `
      <div class="card h-100">
        ${item.image_url ? `<img src="${item.image_url}" class="card-img-top" style="object-fit:cover;height:200px;">` : ''}
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">${item.title}</h5>
          <p class="card-text flex-grow-1">${item.description || ''}</p>
          ${user && user.id === item.owner_id ? 
             `<a href="edit.html?id=${item.id}" class="btn btn-outline-primary mt-auto">Modifier</a>` : ''}
        </div>
      </div>
    `;
    container.appendChild(col);
  });
}
loadItems();
</script>
</body>
</html>
