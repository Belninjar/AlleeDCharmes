<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Les Garages en Bordel – Partage & Dons</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap core -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Masonry for Pinterest‑like grid -->
  <script src="https://cdn.jsdelivr.net/npm/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
  <!-- Google Font for a friendly look -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    :root {
      --primary: #2563eb;  /* Tailwind indigo‑600 */
      --don-color: #10b981;/* Tailwind emerald‑500 */
    }

    body {font-family: "Poppins", sans-serif;background:#f8fafc;min-height:100vh;display:flex;flex-direction:column;}

    /* NAVBAR */
    .navbar-brand{font-weight:600;letter-spacing:-0.5px;}

    /* HERO */
    .hero{background:linear-gradient(135deg,var(--primary),#4f46e5);color:#fff;padding:4rem 0;border-bottom-left-radius:2rem;border-bottom-right-radius:2rem;box-shadow:0 8px 24px rgba(0,0,0,.1);}

    /* CARD */
    .item-card{border-radius:1rem;overflow:hidden;transition:transform .18s ease,box-shadow .18s ease;box-shadow:0 2px 6px rgba(0,0,0,.04);}
    .item-card:hover{transform:translateY(-4px) scale(1.015);box-shadow:0 8px 24px rgba(0,0,0,.08);}
    .item-img{width:100%;height:200px;object-fit:cover;display:block;}
    .badge-pos{position:absolute;top:.75rem;left:.75rem;}

    /* Masonry column gap fix */
    .masonry{margin:-1rem;}
    .masonry-item{padding:1rem;}

    footer{margin-top:auto;background:#eef2ff;padding:.75rem 0;font-size:.875rem;}

  </style>
</head>
<body>

<!-- NAV -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Les Garages&nbsp;en&nbsp;Bordel</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navBar" aria-controls="navBar" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
    <div class="collapse navbar-collapse" id="navBar">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-lg-center gap-lg-2">
        <li class="nav-item"><button id="addBtn" class="btn btn-success w-100">Nouvel&nbsp;objet</button></li>
        <li class="nav-item"><button id="logoutBtn" class="btn btn-outline-light w-100">Déconnexion</button></li>
      </ul>
    </div>
  </div>
</nav>

<!-- HERO -->
<header class="hero text-center">
  <div class="container">
    <h1 class="display-5 fw-bold mb-2">On Partage – On prête – On donne</h1>
    <p class="lead mb-0">Un coin entre voisins pour tenter de vider nos garages et se prêter des trucs.</p>
  </div>
</header>

<main class="container py-5">
  <!-- Search & Filters -->
  <div class="row g-3 align-items-center mb-4">
    <div class="col-12 col-lg-6">
      <div class="input-group shadow-sm">
        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
        <input id="searchBox" type="search" class="form-control" placeholder="Rechercher un objet…" />
        <button id="clearSearch" class="btn btn-outline-secondary" title="Effacer">&times;</button>
      </div>
    </div>
    <div class="col-12 col-lg-6 text-lg-end">
      <div class="btn-group shadow-sm" role="group">
        <button class="btn btn-outline-primary active" data-filter="all">Tous</button>
        <button class="btn btn-outline-primary" data-filter="pret">Prêt</button>
        <button class="btn btn-outline-primary" data-filter="dons">Dons</button>
      </div>
    </div>
  </div>

  <!-- Masonry grid -->
  <div id="items" class="row masonry"></div>
</main>

<footer class="text-center text-muted">&copy;&nbsp;2025 – Les Garages en Bordel - Guillaume</footer>

<!-- Bootstrap JS bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- Bootstrap Icons for the search icon -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
  import { SUPABASE_URL, SUPABASE_ANON_KEY } from './config.js';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* -------- auth -------- */
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) window.location.href = 'login.html';
  const user = session.user;

  /* Nav */
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = 'login.html';
  });
  document.getElementById('addBtn').addEventListener('click', () => {
    window.location.href = 'new.html';
  });

  /* State */
  let currentFilter = 'all';
  let currentQuery = '';

  /* Search */
  document.getElementById('searchBox').addEventListener('input', (e) => {
    currentQuery = e.target.value.trim();
    loadItems();
  });
  document.getElementById('clearSearch').addEventListener('click', () => {
    document.getElementById('searchBox').value = '';
    currentQuery = '';
    loadItems();
  });

  /* Filters */
  document.querySelectorAll('[data-filter]').forEach((btn) =>
    btn.addEventListener('click', () => {
      document.querySelectorAll('[data-filter]').forEach((b) => b.classList.remove('active'));
      btn.classList.add('active');
      currentFilter = btn.dataset.filter;
      loadItems();
    })
  );

  /* Masonry instance */
  let masonry;

  async function loadItems() {
    let q = supabase.from('items').select('*').order('inserted_at', { ascending: false });
    if (currentFilter !== 'all') q = q.eq('category', currentFilter);
    if (currentQuery) q = q.ilike('title', `%${currentQuery}%`);

    const { data, error } = await q;
    const container = document.getElementById('items');
    container.innerHTML = '';

    if (error) {
      container.innerHTML = `<p class="text-danger">${error.message}</p>`;
      return;
    }

    data.forEach((item) => {
      const canEdit = user.id === item.owner_id || user.user_metadata?.is_admin === true;
      const badgeColor = item.category === 'pret' ? 'primary' : 'success';
      const badgeLabel = item.category === 'pret' ? 'Prêt' : 'Don';

      const col = document.createElement('div');
      col.className = 'col-12 col-sm-6 col-lg-4 col-xl-3 masonry-item';
      col.innerHTML = `
        <div class="card item-card position-relative">
          ${item.image_url ? `<img src="${item.image_url}" class="item-img" alt="${item.title}">` : ''}
          <span class="badge bg-${badgeColor} badge-pos">${badgeLabel}</span>
          <div class="card-body d-flex flex-column">
            <h6 class="fw-semibold mb-1">${item.title}</h6>
            <p class="text-muted small mb-1">Villa ${item.villa ?? '?'} – ${item.username ?? 'Anonyme'}</p>
            <p class="small flex-grow-1">${item.description ?? ''}</p>
            ${canEdit ? `<a href="edit.html?id=${item.id}" class="btn btn-outline-primary btn-sm mt-auto">Modifier</a>` : ''}
          </div>
        </div>`;
      container.appendChild(col);
    });

    /* (Re)initialise Masonry */
    masonry?.destroy?.();
    masonry = new Masonry(container, { itemSelector: '.masonry-item', percentPosition: true });
  }

  loadItems();
</script>
</body>
</html>
