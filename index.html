<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Objets — Copro Prêt & Dons</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Copro Objets</a>
    <div class="d-flex">
      <button id="addBtn"    class="btn btn-success me-2">Nouvel objet</button>
      <button id="logoutBtn" class="btn btn-outline-secondary">Déconnexion</button>
    </div>
  </div>
</nav>

<div class="container py-4">

  <!-- barre de recherche -->
  <div class="input-group mb-3">
    <input id="searchBox" type="text" class="form-control" placeholder="Rechercher…">
    <button id="clearSearch" class="btn btn-outline-secondary">×</button>
  </div>

  <!-- filtres prêt / dons -->
  <div class="btn-group mb-4" role="group">
    <button class="btn btn-outline-primary active" data-filter="all">Tous</button>
    <button class="btn btn-outline-primary" data-filter="pret">Prêt</button>
    <button class="btn btn-outline-primary" data-filter="dons">Dons</button>
  </div>

  <!-- cartes -->
  <div id="items" class="row g-4"></div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
import { SUPABASE_URL, SUPABASE_ANON_KEY } from './config.js';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* -------- auth -------- */
const { data: { session } } = await supabase.auth.getSession();
if (!session) window.location.href = 'login.html';
const user = session.user;

/* -------- nav buttons -------- */
document.getElementById('logoutBtn').addEventListener('click', async () => {
  await supabase.auth.signOut();
  window.location.href = 'login.html';
});
document.getElementById('addBtn').addEventListener('click', () => {
  window.location.href = 'new.html';
});

/* -------- états courants -------- */
let currentFilter = 'all';
let currentQuery  = '';

/* -------- écouteurs barre de recherche -------- */
document.getElementById('searchBox').addEventListener('input', e => {
  currentQuery = e.target.value.trim();
  loadItems();
});
document.getElementById('clearSearch').addEventListener('click', () => {
  document.getElementById('searchBox').value = '';
  currentQuery = '';
  loadItems();
});

/* -------- écouteurs filtres -------- */
const filterBtns = document.querySelectorAll('[data-filter]');
filterBtns.forEach(btn =>
  btn.addEventListener('click', () => {
    filterBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.dataset.filter;
    loadItems();
  })
);

/* -------- charge et affiche les objets -------- */
async function loadItems() {
  let q = supabase.from('items')
                  .select('*')
                  .order('inserted_at', { ascending: false });

  if (currentFilter !== 'all') q = q.eq('category', currentFilter);
  if (currentQuery)           q = q.ilike('title', `%${currentQuery}%`);

  const { data, error } = await q;
  const container = document.getElementById('items');
  container.innerHTML = '';

  if (error) {
    container.innerHTML = `<p class="text-danger">${error.message}</p>`;
    return;
  }

  data.forEach(item => {
    const canEdit =
      user.id === item.owner_id ||
      user.user_metadata?.is_admin === true;

    const col = document.createElement('div');
    col.className = 'col-6 col-lg-4'; /* 2 cartes mobile, 3 desktop */

    col.innerHTML = `
      <div class="card h-100">
        ${item.image_url
          ? `<img src="${item.image_url}" class="card-img-top"
                  style="object-fit:cover;height:150px;width:100%;">`
          : ''}
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">${item.title}</h5>
          <p class="card-text small text-muted">
            Villa ${item.villa ?? '?'} – ${item.username ?? 'Anonyme'}
          </p>
          <p class="card-text flex-grow-1">${item.description ?? ''}</p>
          ${
            canEdit
              ? `<a href="edit.html?id=${item.id}"
                    class="btn btn-outline-primary mt-auto">Modifier</a>`
              : ''
          }
        </div>
      </div>`;
    container.appendChild(col);
  });
}

/* -------- première charge -------- */
loadItems();
</script>
</body>
</html>
